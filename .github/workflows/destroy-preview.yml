name: Destroy Preview Environment

# Run this workflow to delete all Cloudflare resources created by setup-preview.yml
# WARNING: This will permanently delete your D1 database, R2 bucket, and Worker
#
# Required GitHub Secrets:
# - CLOUDFLARE_API_TOKEN: Cloudflare API token with permissions to manage Workers, D1, and R2
# - CLOUDFLARE_ACCOUNT_ID: Your Cloudflare account ID

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "DELETE" to confirm destruction of all preview resources'
        required: true
        type: string

permissions:
  contents: read

env:
  PREVIEW_WORKER_NAME: my-app-preview
  PREVIEW_D1_NAME: my-app-preview
  PREVIEW_R2_NAME: my-app-preview

jobs:
  destroy:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'DELETE'
    steps:
      - uses: actions/checkout@v5

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install

      - name: Delete Worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: delete --name ${{ env.PREVIEW_WORKER_NAME }} --force
        continue-on-error: true

      - name: Delete D1 database
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: d1 delete ${{ env.PREVIEW_D1_NAME }} --skip-confirmation
        continue-on-error: true

      - name: Delete R2 bucket
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: r2 bucket delete ${{ env.PREVIEW_R2_NAME }}
        continue-on-error: true

      - name: Destruction complete
        run: |
          echo "=========================================="
          echo "Preview environment destroyed!"
          echo "=========================================="
          echo ""
          echo "Resources deleted:"
          echo "- Worker: ${{ env.PREVIEW_WORKER_NAME }}"
          echo "- D1 database: ${{ env.PREVIEW_D1_NAME }}"
          echo "- R2 bucket: ${{ env.PREVIEW_R2_NAME }}"
          echo ""
          echo "Don't forget to remove these GitHub secrets if no longer needed:"
          echo "- PREVIEW_D1_DATABASE_ID"
          echo "- PREVIEW_PAYLOAD_SECRET"
          echo "=========================================="

  cancelled:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm != 'DELETE'
    steps:
      - name: Destruction cancelled
        run: |
          echo "=========================================="
          echo "Destruction cancelled!"
          echo "=========================================="
          echo ""
          echo "You must type 'DELETE' to confirm destruction."
          echo "No resources were deleted."
          echo "=========================================="
          exit 1
